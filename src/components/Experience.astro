---
const colorMap: Record<string, string> = {
  blue: "text-blue-400 border-blue-500/30 bg-blue-500/10",
  purple: "text-purple-400 border-purple-500/30 bg-purple-500/10",
  green: "text-green-400 border-green-500/30 bg-green-500/10",
  yellow: "text-yellow-400 border-yellow-500/30 bg-yellow-500/10",
  pink: "text-pink-400 border-pink-500/30 bg-pink-500/10",
  cyan: "text-cyan-400 border-cyan-500/30 bg-cyan-500/10",
};

const solidColors: Record<string, string> = {
  blue: 'bg-blue-500',
  purple: 'bg-purple-500',
  green: 'bg-green-500',
  yellow: 'bg-yellow-500',
  pink: 'bg-pink-500',
  cyan: 'bg-cyan-500'
};

const categories = [
  { id: 'blue', label: 'Mainframe & Systèmes' },
  { id: 'purple', label: 'Dév & Logiciel' },
  { id: 'green', label: 'Infra & DevOps' },
  { id: 'yellow', label: 'Pilotage & Soft' },
  { id: 'pink', label: 'Industrie' },
  { id: 'cyan', label: 'IoT & Maker' },
];

const experiences = [
    {
        role: `Ingénieur Mainframe & Interopérabilité`,
        company: `Solutec & CAGIP (Rodez)`,
        date: `09/2023 – Présent`,
        description: `MCO et Run z/OS, modernisation via Python et Zowe, projets techniques (Ansible, GitLab CI) et AppOps.`,
        tags: [
            { name: `z/OS`, color: `blue` },
            { name: `TSO`, color: `blue` },
            { name: `USS`, color: `blue` },
            { name: `JCL`, color: `blue` },
            { name: `DB2`, color: `blue` },
            { name: `Zowe`, color: `blue` },
            { name: `Rexx`, color: `blue` },
            { name: `Python`, color: `purple` },
            { name: `Ansible`, color: `green` },
            { name: `Git`, color: `green` },
            { name: `SQL`, color: `purple` },
            { name: `Astreintes`, color: `blue` }
        ],
        details: [
            {
                title: `MCO & Run z/OS`,
                content: `Installation de matière CATS, suivi de production, astreintes et diagnostic incidents.
Maîtrise de l'environnement USS (Z Linux).
Garantie de la disponibilité et de la performance des environnements critiques.`
            },
            {
                title: `Modernisation`,
                content: `Exploitation de Python sur Mainframe (requêtes SQL, appels API, automatisation de traitements).
Pilote sur le déploiement de Zowe pour moderniser l'expérience développeur.`,
            },
            {
                title: `Projets techniques & AppOps`,
                content: `Outil moderne de gestion de logs Mainframe, playbooks Ansible et pipelines GitLab CI.
Accompagnement des squads CATS, interface entre besoins applicatifs et contraintes d'exploitation.`
            }
        ]
    },
    {
        role: `Manager Projets & Ingénieur DevOps`,
        company: `Stellantis (Trnava - Slovaquie)`,
        date: `2021 – 2023`,
        description: `Encadrement de 4 stagiaires, développement Fullstack et collecte de données industrielles.`,
        tags: [
            { name: `Management`, color: `yellow` },
            { name: `DevOps`, color: `green` },
            { name: `Docker`, color: `green` },
            { name: `Grafana`, color: `green` },
            { name: `Python`, color: `purple` },
            { name: `Agile`, color: `yellow` },
            { name: `Kanban`, color: `yellow` }
        ],
        details: [
            {
                title: `Management`,
                content: `Encadrement de 4 stagiaires et pilotage de projets IT dans un environnement industriel.`
            },
            {
                title: `Développement`,
                content: `Applications Fullstack (React/NodeJS), pipelines CI/CD et monitoring temps réel (Grafana, Node-Red).`
            },
            {
                title: `Data`,
                content: `Conception de tableaux de bord PowerBI et collecte automatisée de données industrielles.`
            }
        ]
    },
    {
        role: `Ingénieur Projets Logistique & Amélioration Continue`,
        company: `LISI Aerospace (Parthenay) — Alternance puis CDI`,
        date: `2016 – 2021`,
        description: `Développement logiciel, optimisation de flux et déploiement Lean.`,
        tags: [
            { name: `Logistique`, color: `yellow` },
            { name: `Lean`, color: `yellow` },
            { name: `Amélioration continue`, color: `yellow` },
            { name: `VSM`, color: `yellow` },
            { name: `5S`, color: `yellow` },
            { name: `PDCA`, color: `yellow` },
            { name: `Industrie`, color: `pink` }
        ],
        details: [
            {
                title: `Logiciel`,
                content: `Développement d'outils de gestion et de suivi de production internes.`
            },
            {
                title: `Logistique`,
                content: `Optimisation de flux, implantation de zones de stockage pour usines neuves.`
            },
            {
                title: `Lean`,
                content: `Déploiement d'outils Lean (5S, VSM, PDCA) et amélioration de la satisfaction client.`
            }
        ]
    }
];

const education = [
    {
        role: `Sécurité & Réseaux (Autodidacte)`,
        company: `TU Graz (Autriche)`,
        date: `09/2022 – 02/2023`,
        description: `Suivi de cours en autonomie sur la sécurité réseau et les systèmes.`,
        tags: [
            { name: `Network Security`, color: `green` },
            { name: `CTF`, color: `cyan` },
            { name: `Intelligence Artificielle`, color: `purple` },
            { name: `AR/VR`, color: `cyan` }
        ],
        details: [
            {
                title: `Cursus`,
                content: `Sécurité réseau, CTF, Intelligence Artificielle et Réalité Augmentée.`
            }
        ]
    },
    {
        role: `Ingénieur Aéronautique & Spatial (Alternance)`,
        company: `CNAM / ISAE-Supaero / ISAE-ENSMA`,
        date: `2016 – 2019`,
        description: `Diplôme d'ingénieur en alternance. Aérodynamique, propulsion, thermodynamique, matériaux composites et mécanique des fluides.`,
        tags: [
            { name: `Ingénierie`, color: `pink` },
            { name: `Aéronautique`, color: `pink` },
            { name: `Spatial`, color: `pink` },
            { name: `Matériaux Composites`, color: `pink` },
            { name: `Mécanique des fluides`, color: `pink` },
            { name: `Alternance`, color: `yellow` },
            { name: `CAO`, color: `pink` }
        ],
        details: [
            {
                title: `CNAM, Poitiers`,
                content: `Fondamentaux de l'ingénierie.
Sciences industrielles et gestion de projet.`
            },
            {
                title: `ISAE-Supaero, Toulouse`,
                content: `Formation intensive en ingénierie aéronautique et spatiale.
Mécanique des fluides et résistance des matériaux.`
            },
            {
                title: `ISAE-ENSMA, Poitiers`,
                content: `Spécialisation en thermodynamique.`
            }
        ]
    },
    {
        role: `Stage International`,
        company: `Malaisie`,
        date: `2018 (3 mois)`,
        description: `Stage de découverte dans une école de cuisine en Malaisie. Immersion linguistique et culturelle.`,
        tags: [
            { name: `Anglais`, color: `yellow` },
            { name: `International`, color: `yellow` },
            { name: `Ouverture culturelle`, color: `yellow` },
            { name: `Immersion`, color: `yellow` }
        ],
        details: [
            {
                title: `Objectifs`,
                content: `Perfectionnement de l'anglais en immersion totale.
Découverte d'un environnement professionnel international.`
            }
        ]
    },
    {
        role: `DUT Science et Génie des Matériaux`,
        company: `IUT Nantes`,
        date: `2014 – 2016`,
        description: `Étude des métaux, polymères, composites et caractérisation mécanique.`,
        tags: [
            { name: `Matériaux`, color: `pink` },
            { name: `Composites`, color: `pink` },
            { name: `Procédés industriels`, color: `pink` },
            { name: `Métaux`, color: `pink` },
            { name: `Polymères`, color: `pink` },
            { name: `Physique`, color: `pink` },
            { name: `Chimie`, color: `pink` }
        ],
        details: [
            {
                title: `Formation`,
                content: `Étude approfondie des matériaux (métaux, polymères, composites).
Procédés de mise en forme et caractérisation mécanique.`
            }
        ]
    }
];

// Combine all tags for modal search
const allTagsByCategory = categories.reduce((acc, cat) => {
  const tags = [...experiences, ...education]
    .flatMap(item => item.tags)
    .filter(tag => tag.color === cat.id)
    .map(tag => tag.name);
  acc[cat.id] = [...new Set(tags)].sort();
  return acc;
}, {} as Record<string, string[]>);

// Build sidebar items with sub-entries
const sidebarSections = [
  {
    id: 'experience',
    label: 'Expérience',
    children: experiences.map((exp, i) => ({ id: `exp-${i}`, label: exp.company.split('(')[0].trim() }))
  },
  {
    id: 'formation',
    label: 'Formation',
    children: education.map((edu, i) => ({ id: `edu-${i}`, label: edu.company.split('(')[0].trim() }))
  },
];

const cardItems = [
  { id: 'experience', title: 'Expériences professionnelles', items: experiences, prefix: 'exp' },
  { id: 'formation', title: 'Formations', items: education, prefix: 'edu' },
];


---

<div class="bg-gray-900 text-white pt-24 pb-16 relative">
  <div class="max-w-7xl mx-auto px-4 flex gap-0 md:gap-8">

    <!-- Sticky Sidebar (Desktop only) -->
    <aside class="hidden lg:block w-56 shrink-0">
      <nav class="sticky top-28 space-y-6" id="sidebar-nav">
        <!-- Main Navigation -->
        <div class="space-y-1">
          {sidebarSections.map(s => (
            <div>
              <a href={`#${s.id}`} data-section={s.id}
                 class="sidebar-link block px-4 py-2 text-sm font-medium text-gray-500 rounded-lg border-l-2 border-transparent hover:text-white hover:bg-gray-800/50 transition-all">
                {s.label}
              </a>
              {s.children.length > 0 && (
                <div class="ml-4 mt-0.5 space-y-0.5">
                  {s.children.map(child => (
                     <a href={`#${child.id}`} data-section={child.id}
                        class="sidebar-link block px-3 py-1 text-xs text-gray-600 rounded-md border-l-2 border-transparent hover:text-gray-300 hover:bg-gray-800/30 transition-all truncate">
                      {child.label}
                    </a>
                  ))}
                </div>
              )}
            </div>
          ))}
        </div>

        <!-- Legend in Sidebar -->
        <div class="pt-16 border-t border-gray-800 hidden lg:block">
           <h3 class="px-4 text-[11px] font-bold text-gray-500 uppercase tracking-widest mb-4">Légende</h3>
           <div class="space-y-1">
             {categories.map(cat => (
               <button 
                 class="w-full text-left px-4 py-1.5 rounded-md text-[11px] font-semibold transition-all hover:bg-white/5 flex items-center gap-3 group category-btn"
                 data-category={cat.id}
                 data-label={cat.label}
                 data-tags={JSON.stringify(allTagsByCategory[cat.id])}
               >
                 <span class={`w-2.5 h-2.5 rounded-full ${solidColors[cat.id]} shadow-lg shadow-${cat.id}-500/20`}></span>
                 <span class="text-gray-400 group-hover:text-gray-200 transition-colors uppercase tracking-tight">{cat.label}</span>
               </button>
             ))}
           </div>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 min-w-0">

      <!-- Professional Introduction -->
      <section class="mb-12">
        <div class="bg-blue-600/10 border border-blue-500/20 p-8 rounded-2xl shadow-2xl backdrop-blur-sm">
          <h1 class="text-4xl font-extrabold text-white mb-4 tracking-tight">Ingénieur Mainframe & Interopérabilité</h1>
          <p class="text-xl text-gray-300 leading-relaxed italic">
            "Ma double compétence en <strong>Mainframe</strong> et <strong>Open</strong> me permet de moderniser les infrastructures historiques en y intégrant les meilleures pratiques d'automatisation et d'agilité."
          </p>
        </div>
      </section>

      {cardItems.map(section => (
        <section id={section.id} class="mb-20">
          <h2 class="text-3xl font-bold mb-10 bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
            {section.title}
          </h2>

          <div class="space-y-6">
            {section.items.map((item, i) => (
              <div id={`${section.prefix}-${i}`} class="bg-gray-800/50 p-5 rounded-xl border border-gray-700/50 hover:border-blue-500/30 transition-all group">
                <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-2 mb-3">
                  <div>
                    <h3 class="text-xl font-bold group-hover:text-blue-300 transition-colors uppercase tracking-tight">{item.role}</h3>
                    <p class="text-gray-400 text-base font-medium">{item.company}</p>
                  </div>
                  <span class="text-blue-400 text-sm font-mono bg-gray-900/80 px-3 py-1 rounded-full border border-gray-700 whitespace-nowrap self-start">
                    {item.date}
                  </span>
                </div>

                <p class="text-gray-300 text-base italic mb-4">{item.description}</p>
                
                <div class="grid gap-2">
                  {item.details.map((detail) => (
                    <div class="bg-gray-700/30 p-3 rounded-lg border-l-2 border-blue-500">
                      <h4 class="font-bold text-white text-sm mb-1">{detail.title}</h4>
                      <ul class="space-y-1">
                        {detail.content.split('\n').filter(line => line.trim() !== '').map(line => (
                          <li class="text-sm text-gray-300 leading-relaxed flex items-start gap-2">
                            <span class="text-blue-400 font-bold shrink-0 mt-0.5">›</span>
                            <span>{line.trim()}</span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  ))}
                </div>

                <div class="flex flex-wrap gap-1.5 mt-4">
                  {item.tags.map((tag) => (
                    <span class={`px-2 py-0.5 text-xs rounded-md border ${colorMap[tag.color] || colorMap.blue}`}>
                      {tag.name}
                    </span>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </section>
      ))}
    </main>
  </div>

  <!-- Tag Detail Modal -->
  <div id="tag-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-gray-950/80 backdrop-blur-sm">
    <div class="bg-gray-900 border border-gray-800 w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-300">
      <div class="p-6 border-b border-gray-800 flex items-center justify-between">
        <div>
           <h2 id="modal-title" class="text-xl font-bold text-white mb-1">Détail des compétences</h2>
           <p id="modal-subtitle" class="text-sm text-gray-400"></p>
        </div>
        <button id="close-modal" class="text-gray-500 hover:text-white transition-colors p-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-6 max-h-[60vh] overflow-y-auto">
        <div id="modal-tags" class="flex flex-wrap gap-3 text-sm font-medium">
          <!-- Dynamically filled -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Legend & Modal Logic
  const modal = document.getElementById('tag-modal');
  const closeBtn = document.getElementById('close-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalSubtitle = document.getElementById('modal-subtitle');
  const modalTagsContainer = document.getElementById('modal-tags');
  const categoryBtns = document.querySelectorAll('.category-btn');

  const colorClasses: Record<string, string> = {
    blue: "text-blue-400 border-blue-500/30 bg-blue-500/10",
    purple: "text-purple-400 border-purple-500/30 bg-purple-500/10",
    green: "text-green-400 border-green-500/30 bg-green-500/10",
    yellow: "text-yellow-400 border-yellow-500/30 bg-yellow-500/10",
    pink: "text-pink-400 border-pink-500/30 bg-pink-500/10",
    cyan: "text-cyan-400 border-cyan-500/30 bg-cyan-500/10",
  };

  categoryBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const catId = btn.getAttribute('data-category');
      const label = btn.getAttribute('data-label');
      const tags = JSON.parse(btn.getAttribute('data-tags') || '[]');
      
      modalTitle.innerText = label;
      modalSubtitle.innerText = `${tags.length} compétence(s) répertoriée(s)`;
      modalTagsContainer.innerHTML = '';
      
      tags.forEach(tag => {
        const span = document.createElement('span');
        span.className = `px-3 py-1.5 rounded-lg border ${colorClasses[catId || 'blue']}`;
        span.innerText = tag;
        modalTagsContainer.appendChild(span);
      });
      
      modal?.classList.remove('hidden');
      modal?.classList.add('flex');
    });
  });

  const closeModal = () => {
    modal?.classList.add('hidden');
    modal?.classList.remove('flex');
  };

  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });

  // Sidebar Scroll Logic
  const links = document.querySelectorAll('.sidebar-link');
  const targets = document.querySelectorAll('main > section[id]');
  
  function updateActive() {
    let current = '';
    targets.forEach(el => {
      const top = el.getBoundingClientRect().top;
      if (top <= 150) current = el.id;
    });
    
    links.forEach(link => {
      const isActive = link.getAttribute('data-section') === current;
      link.classList.toggle('text-white', isActive);
      link.classList.toggle('text-gray-500', !isActive && link.classList.contains('text-sm'));
      link.classList.toggle('text-gray-600', !isActive && !link.classList.contains('text-sm'));
      link.classList.toggle('text-gray-300', isActive && !link.classList.contains('text-sm'));
      link.classList.toggle('border-blue-500', isActive);
      link.classList.toggle('border-transparent', !isActive);
      link.classList.toggle('bg-gray-800/50', isActive && link.classList.contains('text-sm'));
    });
  }
  
  window.addEventListener('scroll', updateActive);
  updateActive();
</script>
